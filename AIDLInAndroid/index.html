<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          记一次AIDL的学习与实践 - SpirytusZ&#39;s Blog
        
    </title>

    <link rel="canonical" href="https://spirytusz.co/AIDLInAndroid/">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/hux-blog.min.css">


    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 7.3.0"></head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">SpirytusZ&#39;s Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="https://spirytusz.co/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('aidlInAndroid_cover.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#Android" title="Android">Android</a>
                        
                          <a class="tag" href="/tags/#多进程" title="多进程">多进程</a>
                        
                    </div>
                    <h1>记一次AIDL的学习与实践</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by spirytusz on
                        2018-11-25
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>终于考完试了hhh，终于有时间更新博客了。正好之前自学跨进程编程，写个博文记录一下。</p>
<span id="more"></span>

<h2 id="2-Android中的多进程"><a href="#2-Android中的多进程" class="headerlink" title="2. Android中的多进程"></a>2. Android中的多进程</h2><p>在Android中，默认情况下，应用中的组件是运行在同一个进程的。我们可以在AndroidManifest.xml中使用<code>android:process</code>属性来为四大组件指定运行的进程。比如对于Service：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">...</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:process</span>=<span class="string">&quot;:playMusicProcess&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">...</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当然也可以通过JNI，在C&#x2F;C++代码中调用fork()来开启进程，这里不讨论这种情况。</p>
<p>然而，好端端的为什么要使用多进程？因为多进程相较于单进程是有好处的。<br>首先，多进程意味着更多内存空间，OOM的概率更小。DVM会给每个进程分配固定的空间。多进程意味着会被分配更多空间，因此合理利用多进程，能够减少OOM发生的概率。<br>其次，像一些功能，相对独立，只需要在后台运行，那我们可以让它运行在另一个进程中的Service，即使UI进程被杀了，这个模块也能正常运行。</p>
<p>接下来看看多进程的实现，我使用AIDL来进行进程间的通信。</p>
<h2 id="3-准备知识：序列化"><a href="#3-准备知识：序列化" class="headerlink" title="3. 准备知识：序列化"></a>3. 准备知识：序列化</h2><p>在跨进程通信中，从一个进程发送消息到另一个进程时，会先把消息进行序列化，通过Binder传给另一个进程，另一个进程再通过反序列化以获得消息。所以在实现跨进程通信之前，我们需要对序列化有一定的了解。<br>在Android开发中我们有两种序列化方案：<code>Serializable接口</code>和<code>Parcelable接口</code>。前者是Java自带的，后者是为Android系统量身打造的。两者各有优劣：<br><code>Serializable接口</code>使用方便，但是性能开销较大，涉及大量I&#x2F;O操作。<br><code>Parcelable接口</code>性能开销小，但使用较为复杂。<br>基于性能优先的原则，我优先使用的是<code>Parcelable接口</code>。</p>
<p>对于一个实体类Music，我们让它实现Parcelable接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Music</span> <span class="keyword">implements</span> <span class="title class_">Parcelable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String mMusicName;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> mMusicDuration;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Music</span><span class="params">(String musicName, <span class="type">long</span> musicDuration)</span> &#123;</span><br><span class="line">        mMusicName = musicName;</span><br><span class="line">        mMusicDuration = musicDuration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Music</span><span class="params">(Parcel source)</span> &#123;</span><br><span class="line">        mMusicName = source.readString();</span><br><span class="line">        mMusicDuration = source.readLong();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMusicName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> musicName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getMusicDuration</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> musicDuration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">describeContents</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeToParcel</span><span class="params">(Parcel dest, <span class="type">int</span> flags)</span> &#123;</span><br><span class="line">        dest.writeString(mMusicName);</span><br><span class="line">        dest.writeLong(mMusicDuration);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;Music&gt; CREATOR = <span class="keyword">new</span> <span class="title class_">Creator</span>&lt;Music&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Music <span class="title function_">createFromParcel</span><span class="params">(Parcel source)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Music</span>(source);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Music[] newArray(<span class="type">int</span> size) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Music</span>[size];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现Parcelable接口，需要定义一个CREATOR变量，并实现方法<code>describeContents()</code>和<code>writeToParcel()</code>。<br>对于变量<code>CREATOR</code>，它是Parcelable.Creator&lt;T&gt;接口一个实现的对象。其中，<code>createFromParcel()</code>是用来反序列化出一个对象，<code>newArray()</code>是用来反序列化出一个对象的数组。这里只需要返回一个空数组即可。<br>对于方法<code>describeContents()</code>，它返回对象内容的描述，如果内容中有文件描述符(File Descriptor, fd)就返回1，否则返回0。这里返回0。<br>对于方法<code>writeToParcel()</code>，它在序列化的时候被调用。在这里面序列化需要序列化的变量。</p>
<blockquote><p>踩坑点： 在<code>writeToParcel</code>按ABCD的顺序序列化，在反序列化的时候也一定要按照ABCD的顺序反序列化。否则会反序列化出一个不正确的对象。</p>
</blockquote>

<p>序列化的一些注意点就基本这样。</p>
<h2 id="4-关于AIDL"><a href="#4-关于AIDL" class="headerlink" title="4. 关于AIDL"></a>4. 关于AIDL</h2><p>AIDL是Android接口定义语言(Android Interface Definition Language, AIDL)，用于规定进程间通信的方式(这里我理解为进程间的通信协议)。<br>它和Java的接口是有些许不同的：</p>
<ol>
<li>AIDL不支持定义静态变量，仅支持定义方法。</li>
<li>AIDL仅支持有限的数据类型：<ul>
<li>基本数据类型：int, long, char, boolean, double等</li>
<li>String和CharSequence</li>
<li>List，仅支持ArrayList，且里面的数据必须是AIDL支持的数据类型</li>
<li>Map，仅支持HashMap，不支持带泛型参数的Map(<a href="http://wing-linux.sourceforge.net/guide/developing/tools/aidl.html#aidlsyntax">参考</a>)</li>
<li>Parcelable，支持所有实现了Parcelable接口的对象</li>
<li>AIDL，支持AIDL接口对象</li>
</ul>
</li>
</ol>
<blockquote><p>踩坑点： 在方法的参数列表中，除了基本类型和AIDL接口外，都需要标注方向in, out, inout<br>in代表数据只能从客户端流向服务端，即客户端 -&gt; 服务端<br>out代表数据只能从服务端流向客户端，即客户端 &lt;- 服务端<br>inout代表数据可以在客户端和服务端之间双向流动，即客户端 &lt;-&gt; 服务端</p>
</blockquote>

<p>另外，Parcelable对象需要在aidl中显式的声明和import<br>如果实体Music.java位于java文件夹中的包com.example.exampleproject.entity包下，那就需要在aidl文件夹中的包com.example.exampleproject.entity下声明Music.aidl，内容为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// Music.aidl</span><br><span class="line">package com.example.exampleproject.entity;</span><br><span class="line"></span><br><span class="line">parcelable Music;</span><br></pre></td></tr></table></figure>
<p>然后在需要用到Music的AIDL文件中显式import出来，无论同不同包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import com.example.exampleproject.entity.Music;</span><br></pre></td></tr></table></figure>

<blockquote><p>如果你用Android Studio来编写AIDL文件，那你就暂时把AS当成文本编辑器吧，不要指望它会帮你代码补全，自动import相关包…</p>
</blockquote>

<p>所以，一个正确的AIDL文件是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// ITest.aidl</span><br><span class="line">package com.example.exampleproject;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">import com.example.exampleproject.entity.Music;</span><br><span class="line"></span><br><span class="line">interface ITest&#123;</span><br><span class="line">    </span><br><span class="line">    void setMusic(in Music music);</span><br><span class="line">    void setMap(in Map map);</span><br><span class="line">    void setList(in List&lt;Music&gt; musicList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-使用AIDL开启多进程模式"><a href="#5-使用AIDL开启多进程模式" class="headerlink" title="5. 使用AIDL开启多进程模式"></a>5. 使用AIDL开启多进程模式</h2><p>好了，我们已经明白了AIDL的正确书写方法，接下来使用AIDL来实现进程间的通信。这里以双向通信为例子：Activity传一个int型的值给Service，Service处理后返回给Activity。<br>这里的Activity，我们取名为MainActivity，Service我们取名为MyService。<br>ok，既然是处理后返回，所以MainActivity中需要有一个回调接口来给MyService回调，但是AIDL不支持普通接口，但支持AIDL接口，因此，我们就用AIDL来声明MainActivity中的回调接口：</p>
<figure class="highlight plaintext"><figcaption><span>ICallback.aidl</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package com.zspirytus.simpleaidltest;</span><br><span class="line"></span><br><span class="line">interface ICallback &#123;</span><br><span class="line">    void callback(int a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Activity和Service之间的通信是通过Binder来实现的，而AIDL接口的内部类<code>Stub</code>的实现也是一个Binder，因为它继承了<code>android.os.Binder</code>接口，因此我们可以在AIDL接口中规定MainActivity和MyService的通信方式。由于我们需要从MainActivity中传值给MyService，并且要给MyService设置MainActivity的回调接口。因此就有：</p>
<figure class="highlight plaintext"><figcaption><span>IAIDLTest.aidl</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">package com.zspirytus.simpleaidltest;</span><br><span class="line"></span><br><span class="line">import com.zspirytus.simpleaidltest.ICallback;</span><br><span class="line"></span><br><span class="line">interface IAIDLTest &#123;</span><br><span class="line">    void testMethod(int a);</span><br><span class="line">    void setCallback(ICallback callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>testMethod()</code>是MainActivity向MyService传值的方法<br><code>setCallback()</code>是MainActivity为MyService设置回调接口的方法。</p>
<p>MainActivity和MyService通信的桥梁已经规定好了，接下来就是实现它。我们在MyService中定义一个内部类MyBinder来实现它：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ICallback mCallback;</span><br><span class="line"></span><br><span class="line">    ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">MyBinder</span> <span class="keyword">extends</span> <span class="title class_">IAIDLTest</span>.Stub &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMethod</span><span class="params">(<span class="type">int</span> a)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            Log.e(<span class="built_in">this</span>.getClass().getSimpleName(), <span class="string">&quot;MyService Receive Msg: &quot;</span> + a + <span class="string">&quot;\t at Thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">            <span class="keyword">if</span> (mCallback != <span class="literal">null</span>)</span><br><span class="line">                mCallback.callback(a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCallback</span><span class="params">(ICallback callback)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            mCallback = callback;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单解释一下，MainActivity通过<code>setCallback()</code>为MyService设置回调接口，当MainActivity通过<code>testMethod()</code>传值给MyService时，MyService会处理传过来的值(这里以打印日志代替)，然后检查一下回调接口是否为空。如果不为空则调用它的回调方法，进而通知MainActivity。</p>
<blockquote><p>如果提示找不到IAIDLTest，可以尝试Clean一下Project尝试解决，如果Gradle报错，请检查AIDL文件是否正确。</p>
</blockquote>

<p>然后补充一下MyService的生命周期，服务端就大功告成了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MyBinder mBinder;</span><br><span class="line">    <span class="keyword">private</span> ICallback mCallback;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mBinder == <span class="literal">null</span>)</span><br><span class="line">            mBinder = <span class="keyword">new</span> <span class="title class_">MyBinder</span>();</span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">MyBinder</span> <span class="keyword">extends</span> <span class="title class_">IAIDLTest</span>.Stub &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMethod</span><span class="params">(<span class="type">int</span> a)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            Log.e(<span class="built_in">this</span>.getClass().getSimpleName(), <span class="string">&quot;MyService Receive Msg: &quot;</span> + a + <span class="string">&quot;\t at Thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">            <span class="keyword">if</span> (mCallback != <span class="literal">null</span>)</span><br><span class="line">                mCallback.callback(a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCallback</span><span class="params">(ICallback callback)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            mCallback = callback;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端已经解决了，现在来看客户端MainActivity。<br>Activity和Service之间的通信可以通过Activity绑定Service的形式来实现，多进程模式下也不例外，但有些许不同。<br>首先声明一个Binder来构建MainActivity与MyService通信的桥梁：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> IAIDLTest mBinder;</span><br></pre></td></tr></table></figure>
<p>然后以内部类的形式实现MyService回调MainActivity的回调接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ICallbackImpl</span> <span class="keyword">extends</span> <span class="title class_">ICallback</span>.Stub &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callback</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> a)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">switch</span> (a) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                a1();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                a2();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">a1</span><span class="params">()</span> &#123;</span><br><span class="line">    mRemoteMsg.setText(<span class="string">&quot;Receive From Remote Service: a = 1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">a2</span><span class="params">()</span> &#123;</span><br><span class="line">    mRemoteMsg.setText(<span class="string">&quot;Receive From Remote Service: a = 2&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其次创建一个<code>ServiceConnection</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">conn = <span class="keyword">new</span> <span class="title class_">ServiceConnection</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> &#123;</span><br><span class="line">        mBinder = IAIDLTest.Stub.asInterface(iBinder);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mBinder.setCallback(mCallback);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> &#123;</span><br><span class="line">        mBinder = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>最后在适当生命周期绑定和解绑Service:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">    ... ...</span><br><span class="line">    bindService();</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    ... ...</span><br><span class="line">    unbindService();</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">bindService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">startServiceIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>, MyService.class);</span><br><span class="line">    bindService(startServiceIntent, conn, BIND_AUTO_CREATE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unbindService</span><span class="params">()</span> &#123;</span><br><span class="line">    unbindService(conn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在适当的时候发送请求就可以了，比如单击按钮发送请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initView</span><span class="params">()</span> &#123;</span><br><span class="line">    findViewById(R.id.btn).setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">            start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mBinder.testMethod(A);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是，毕竟是跨进程通信，当前进程下发起远程请求的线程是会被挂起的。如果发起的请求是一个耗时操作，并且是UI线程发起的，那就会有ANR的风险。因此，安全起见，在发起跨进程请求时，推荐切换到另一个线程后再发起。所以上面的程序可以这么改进：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mBinder.testMethod(A);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread.setName(<span class="string">&quot;myThread&quot;</span>);</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后呢，等到服务端把请求执行完毕后，客户端发起请求的线程会被唤醒，然后继续执行。所以我们不能在回调方法中执行UI更新操作，因为回调方法并不在UI线程中执行(前面在非UI线程中发起请求)。如果需要更新UI，需要切换到UI线程后再更新UI。所以需要如下改进：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ICallbackImpl</span> <span class="keyword">extends</span> <span class="title class_">ICallback</span>.Stub &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">callback</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> a)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        mRemoteMsg.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">switch</span> (a) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                        a1();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                        a2();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此，即使服务端执行耗时操作，界面也不会卡死：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMethod</span><span class="params">(<span class="type">int</span> a)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    SystemClock.sleep(<span class="number">5000</span>);</span><br><span class="line">    Log.e(<span class="built_in">this</span>.getClass().getSimpleName(), <span class="string">&quot;MyService Receive Msg: &quot;</span> + a + <span class="string">&quot;\t at Thread: &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    <span class="keyword">if</span> (mCallback != <span class="literal">null</span>)</span><br><span class="line">    mCallback.callback(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote><p>服务端的方法会在Binder线程池中的线程运行，因此不必担心主线程会被阻塞</p>
</blockquote>

<p>还有一个小问题，如果已经绑定的Service意外死亡怎么办（比如说被系统杀死了）？我们只需要在<code>ServiceConnect#onServiceDisconnected()</code>中重新连接服务即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> &#123;</span><br><span class="line">    bindService();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote><p>MyService被杀死也没关系，<code>MainActivity#bindService()</code>中在绑定MyService时，flag已经被设置为BIND_AUTO_CREATE，会重新启动MyService的。</p>
</blockquote>
<p>由于代码太长，我没有全放，只放一些比较关键的，完整代码可以看<a href="https://github.com/zkw012300/SampleCodeRepo/tree/master/simpleaidltest">这里</a></p>
<p>好了，简单进程间通信的实现就完成了，总结一下，基本步骤：</p>
<ol>
<li>创建AIDL文件搭建客户端和服务端的沟通桥梁</li>
<li>服务端实现AIDL接口</li>
<li>客户端通过ServiceConnection#onServiceConnected()获取Binder对象</li>
<li>在ServiceConnection#onServiceDisconnected()中重新连接，防止Service意外死亡</li>
<li>在客户端使用Binder对象在适当的线程向服务端发送请求</li>
<li>在客户端的适当线程中回调</li>
</ol>
<h2 id="6-实践-简单的音乐播放器实现"><a href="#6-实践-简单的音乐播放器实现" class="headerlink" title="6. 实践 - 简单的音乐播放器实现"></a>6. 实践 - 简单的音乐播放器实现</h2><p>明白了进程间通讯的流程，接下来我们来实现一个简单的音乐播放功能吧。<br>我们需要完成：</p>
<ol>
<li>Activity和Service在不同进程</li>
<li>默认进程中的Activity控制音乐播放暂停，接收来自另一个进程的Service发送的播放进度并显示</li>
<li>另一个进程的Service负责播放音乐，发送播放进度给Activity。</li>
</ol>
<p>这个音乐播放器，至少要能播放、暂停、显示播放进度。我们可以把播放暂停和显示播放进度这两个功能分离，分别管理。<br>对于播放暂停，只需要简单的定义两个方法<code>play()</code>和<code>pause()</code>即可：</p>
<figure class="highlight plaintext"><figcaption><span>IPlayControl.aidl</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// IPlayControl.aidl</span><br><span class="line">package com.zspirytus.simplemusicplayer;</span><br><span class="line"></span><br><span class="line">import com.zspirytus.simplemusicplayer.entity.Music;</span><br><span class="line"></span><br><span class="line">interface IPlayControl &#123;</span><br><span class="line">    void play(in Music music);</span><br><span class="line">    void pause();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于获取播放进度的问题，我们采取订阅 - 发布的模式，需要获取播放进度的对象，传一个回调接口给被观察者，即服务端。<br>以下分别是订阅取消订阅和回调接口的AIDL文件：</p>
<figure class="highlight plaintext"><figcaption><span>IPlayProgressRegister.aidl</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// IPlayProgressRegister.aidl</span><br><span class="line">package com.zspirytus.simplemusicplayer;</span><br><span class="line"></span><br><span class="line">import com.zspirytus.simplemusicplayer.IOnProgressChange;</span><br><span class="line"></span><br><span class="line">interface IPlayProgressRegister &#123;</span><br><span class="line">    void registerProgressObserver(IOnProgressChange observer);</span><br><span class="line">    void unregisterProgressObserver(IOnProgressChange observer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><figcaption><span>IOnProgressChange.aidl</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// IOnProgressChange.aidl</span><br><span class="line">package com.zspirytus.simplemusicplayer;</span><br><span class="line"></span><br><span class="line">interface IOnProgressChange &#123;</span><br><span class="line">    void onProgressChange(int seconds);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，就要实现服务端了。但是，前面音乐播放控制功能和进度获取功能已经被我分离了，换言之，就是有两个Binder。但是一个Service只能有一个Binder和外界沟通啊？怎么解决？不如我们定义一个Binder连接池，根据适当的请求码binderCode来返回对应的Binder。这个Binder连接池能被客户端拿到，所以它应该由AIDL实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// IBinderPool.aidl</span><br><span class="line">package com.zspirytus.simplemusicplayer;</span><br><span class="line"></span><br><span class="line">interface IBinderPool &#123;</span><br><span class="line">    IBinder getBinder(int binderCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Binder连接池已经定义好了，接下来就是实现服务端了，同样的，我还是用内部类的方式实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PlayMusicService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    </span><br><span class="line">    ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PLAY_CONTROL_BINDER</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PLAY_PROGRESS_REGISTER_BINDER</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BinderPool mBinder;</span><br><span class="line">    <span class="keyword">private</span> PlayControl mPlayControl;</span><br><span class="line">    <span class="keyword">private</span> PlayProgressRegister mPlayProgressRegister;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RemoteCallbackList&lt;IOnProgressChange&gt; mIOnProgressChangeList = <span class="keyword">new</span> <span class="title class_">RemoteCallbackList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BinderPool</span> <span class="keyword">extends</span> <span class="title class_">IBinderPool</span>.Stub &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> IBinder <span class="title function_">getBinder</span><span class="params">(<span class="type">int</span> binderCode)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="keyword">switch</span> (binderCode) &#123;</span><br><span class="line">                <span class="keyword">case</span> PLAY_CONTROL_BINDER:</span><br><span class="line">                    <span class="keyword">if</span> (mPlayControl == <span class="literal">null</span>)</span><br><span class="line">                        mPlayControl = <span class="keyword">new</span> <span class="title class_">PlayControl</span>();</span><br><span class="line">                    <span class="keyword">return</span> mPlayControl;</span><br><span class="line">                <span class="keyword">case</span> PLAY_PROGRESS_REGISTER_BINDER:</span><br><span class="line">                    <span class="keyword">if</span> (mPlayProgressRegister == <span class="literal">null</span>)</span><br><span class="line">                        mPlayProgressRegister = <span class="keyword">new</span> <span class="title class_">PlayProgressRegister</span>();</span><br><span class="line">                    <span class="keyword">return</span> mPlayProgressRegister;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PlayControl</span> <span class="keyword">extends</span> <span class="title class_">IPlayControl</span>.Stub &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">play</span><span class="params">(Music music)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            MyMediaPlayer.getInstance().play(music);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pause</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            MyMediaPlayer.getInstance().pause();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PlayProgressRegister</span> <span class="keyword">extends</span> <span class="title class_">IPlayProgressRegister</span>.Stub &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerProgressObserver</span><span class="params">(IOnProgressChange observer)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            mIOnProgressChangeList.register(observer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unregisterProgressObserver</span><span class="params">(IOnProgressChange observer)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            mIOnProgressChangeList.unregister(observer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在IBinderPool.Stub的实现BinderPool中，会根据传递过来的binderCode来返回对应的已被实例化的Binder。<br><code>MyMediaPlayer</code>是我对MediaPlayer的一个很简单的封装，拿来当例子够了。<br>接下来补上Service的生命周期就ok了，代码比较长，我就不贴了。</p>
<p>接下来看客户端的实现：<br>首先定义从Service端获得的Binder对象，然后在ServiceConnection中获取Binder和重连Service。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> IBinderPool mBinder;</span><br><span class="line"><span class="keyword">private</span> ServiceConnection conn;</span><br><span class="line"></span><br><span class="line">conn = <span class="keyword">new</span> <span class="title class_">ServiceConnection</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> &#123;</span><br><span class="line">        mBinder = IBinderPool.Stub.asInterface(iBinder);</span><br><span class="line">        register();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> &#123;</span><br><span class="line">        bindService();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接着，实现回调接口并传给Service，以供其传递播放进度给Activity（上一个步骤的<code>register()</code>方法已经把回调接口传给了Service）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">IOnProgressChangeImpl</span> <span class="keyword">extends</span> <span class="title class_">IOnProgressChange</span>.Stub &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onProgressChange</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> currentMilliseconds)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        mProgressText.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                mProgressText.setText(DateUtil.getMinutesSeconds(currentMilliseconds));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后就是请求部分，在客户端中，我们获得是Binder连接池的对象，我们可以传binderCode来获得对应的Binder:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PLAY_CONTROL_BINDER</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PLAY_PROGRESS_REGISTER_BINDER</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Music</span> <span class="variable">sampleMusic</span> <span class="operator">=</span> MusicFactory.getSampleMusic();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mPlayControl == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">IBinder</span> <span class="variable">iBinder</span> <span class="operator">=</span> mBinder.getBinder(PLAY_CONTROL_BINDER);</span><br><span class="line">                    mPlayControl = IPlayControl.Stub.asInterface(iBinder);</span><br><span class="line">                &#125;</span><br><span class="line">                mPlayControl.play(sampleMusic);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">pause</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mPlayControl == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">IBinder</span> <span class="variable">iBinder</span> <span class="operator">=</span> mBinder.getBinder(PLAY_CONTROL_BINDER);</span><br><span class="line">                    mPlayControl = IPlayControl.Stub.asInterface(iBinder);</span><br><span class="line">                &#125;</span><br><span class="line">                mPlayControl.pause();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在AndroidManifest.xml中为Service指定进程，就大功告成了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.zspirytus.simplemusicplayer.PlayMusicService&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:enabled</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:process</span>=<span class="string">&quot;:playMusicService&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于代码太长，我没有全放，只放一些比较关键的，完整代码可以看<a href="https://github.com/zkw012300/SampleCodeRepo/tree/master/simplemusicplayer">这里</a>。</p>
<h2 id="7-总结"><a href="#7-总结" class="headerlink" title="7. 总结"></a>7. 总结</h2><p>我目前的理解是，在Android跨进程通讯中，一般是序列化+接口+线程切换。只要注意这三点一般没大问题。</p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/theSummaryOf2018/" data-toggle="tooltip" data-placement="top" title="2018年度总结">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/DFS/" data-toggle="tooltip" data-placement="top" title="关于深度优先搜索的一点小心得">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                

                <!-- Friends Blog -->
                
            </div>

        </div>
    </div>
</article>




<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "spirytusz";
    var disqus_identifier = "https://spirytusz.co/AIDLInAndroid/";
    var disqus_url = "https://spirytusz.co/AIDLInAndroid/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->






    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/spirytusz">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; SpirytusZ&#39;s Blog 2025 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    Ported by <a href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/hux-blog.min.js"></script>



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://spirytusz.co/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->


<!-- Side Catalog -->





<!-- Image to hack wechat -->
<img src="https://spirytusz.co/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
